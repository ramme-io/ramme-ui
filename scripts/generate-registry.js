const fs = require('fs');
const path = require('path');

// --- CONFIGURATION ---
// The "Baton" passed from generate-manifest.js
const TEMP_FILE = path.resolve(__dirname, 'manifest.temp.json');
// The Output file for the library
const OUTPUT_FILE = path.join(__dirname, '../src/component-registry.ts');

function generateRegistry() {
  console.log('üè≠ Generating Component Registry from Manifest...');

  // 1. Safety Check: Did the first script run?
  if (!fs.existsSync(TEMP_FILE)) {
    console.error('‚ùå Error: manifest.temp.json not found.');
    console.error('üëâ Make sure to run "generate-manifest.js" first.');
    process.exit(1);
  }

  // 2. Read the "Truth" from the Manifest step
  const components = JSON.parse(fs.readFileSync(TEMP_FILE, 'utf-8'));

  // 3. Build Import Statements
  // We use the 'path' calculated by the previous script (e.g. "./components/ui/Button")
  const imports = components.map(c => `import { ${c.name} } from '${c.path}';`).join('\n');
  
  // 4. Build the Registry Object
  const mappingLines = components.map(c => {
    // A. PascalCase (Standard) -> "DataTable": DataTable
    let lines = `  '${c.name}': ${c.name},`;
    
    // B. kebab-case (Stable ID from Manifest) -> "data-table": DataTable
    // This connects the CMS/Wizard ID directly to the code!
    if (c.id && c.id !== c.name) {
      lines += `\n  '${c.id}': ${c.name},`;
    }

    // C. lowercase (Robustness Fallback) -> "datatable": DataTable
    const lower = c.name.toLowerCase();
    // Avoid duplicates if ID or Name is already lowercase
    if (lower !== c.id && lower !== c.name) {
       lines += `\n  '${lower}': ${c.name},`;
    }

    return lines;
  }).join('\n');

  // 5. Construct File Content
  const fileContent = `// ‚ö†Ô∏è AUTO-GENERATED by scripts/generate-registry.js
// Do not edit manually.
import React from 'react';
${imports}

export const AUTO_REGISTRY: Record<string, React.FC<any>> = {
${mappingLines}
};
`;

  // 6. Write to Disk
  fs.writeFileSync(OUTPUT_FILE, fileContent);
  
  // 7. Cleanup (Optional but clean)
  // We remove the temp file so it doesn't get committed or stale
  fs.unlinkSync(TEMP_FILE);
  
  console.log(`‚úÖ Generated registry with ${components.length} components.`);
  console.log(`üßπ Cleaned up temp file.`);
}

generateRegistry();